<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weibo-vue</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="weibo" class="page" v-cloak>
        <div v-if="isLogin">
            <!--<a href="javascript:;" @click="logout">退出</a>-->
            <div v-if="userInfo" class="header">
                <div class="inner">
                    <a class="profile_image" href="javascript:;" :title="userInfo.name +'——'+ userInfo.description">
                        <img :src="userInfo.profile_image_url" :alt="userInfo.name">
                    </a>
                </div>
                <ul class="items">
                    <li v-for="status in friendsTimeline.statuses">{{status.text}}</li>
                </ul>
            </div>
        </div>
        <div v-else @click="login" class="login-btn"></div>
        
        <div v-if="errorInfo" class="error">
            {{errorInfo.error_code+":"+errorInfo.error}}
        </div>
    </div>
    <script src="//tjs.sjs.sinajs.cn/open/api/js/wb.js?appkey=2199529438"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/vue/2.0.3/vue.js"></script>
    <script>
        (function() {
            // 常量
            const CONFIG = WB2._config;
            const STATUS = WB2.checkLogin();
            const VM = new Vue({
                el: '#weibo',
                data: {
                    userInfo: '',
                    friendsTimeline: '',
                    errorInfo: '',
                    isLogin: STATUS
                },
                created: function() {
                    // 获取登录用户信息
                    this.getUserInfo();
                    // 获取登录用户信息的微博流
                    this.getFriendsTimeline();
                },
                methods: {
                    login: function() {
                        WB2.login(function() {
                            this.isLogin = true;
                        }.bind(this));
                    },
                    logout: function() {
                        WB2.logout(function() {
                            this.isLogin = false;
                        }.bind(this));
                    },
                    getUserInfo: function() {
                        var _this = this;
                        WB2.anyWhere(function(W){
                            //数据交互
                            W.parseCMD('/users/show.json', function(oResult, bStatus) {
                                if(bStatus) {
                                    _this.userInfo = oResult;
                                } else {
                                    _this.errorInfo = oResult;
                                }
                            }, {"uid" : CONFIG.uid}, {method: 'get', cache_time: 0});
                        })
                    },
                    getFriendsTimeline: function() {
                        var _this = this;
                        WB2.anyWhere(function(W){
                            //数据交互
                            W.parseCMD('/statuses/friends_timeline.json', function(oResult, bStatus) {
                                if(bStatus) {
                                    _this.friendsTimeline = oResult;
                                } else {
                                    _this.errorInfo = oResult;
                                }
                            }, {"uid" : CONFIG.uid}, {method: 'get', cache_time: 0});
                        })
                    }
                }
            });
        }())
    </script>
</body>
</html>