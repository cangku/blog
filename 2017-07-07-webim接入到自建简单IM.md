---
title: webim接入到自建简单IM
tags:
  - work
categories:
  - 学习
date: 2017-07-07 00:00:00
---
项目中需要使用腾讯的云通讯，其中页面这块有场景需要使用到 WebIm 。同时几个项目均会使用到 WebIm。demo 中的代码不能直接拿到项目中使用（其实不是很符合我们的代码的气质），于是就按需重写了一些。  

项目是基于开源 Hybrid 框架 [Blade](https://github.com/yexiaochai/blade) 进行的开发，有些不同的是我们把 Vue 结合进去替换掉了 Blade 中的 view 层，开发过程中感觉效率也高了很多（没用过blade本身的视图功能，作为使用主义，用就是了）。  
<!-- more -->
## Demo中聊起来
[DEMO](https://www.qcloud.com/document/product/269/4196) 其实没有能够聊起来。游客身份进入没有聊天对象，没有玩转，索性就自己注册了应用（申请的应用帐号也下来的，native这边已经愉快的聊起来了）。  

### 测试应用
直接游客身份进入

### 自建应用
- SdkAppId
- AccountType

正式开发中也会需要这两个参数，只是需要注意的是帐号体系集成的时候按照自己的实际情况选择，自己有帐号体系就选择“独立模式” ，没有就只能使用托管模式。  

### 功能与流程熟悉
本来想找一个巴适的流程图工具帮忙分析一下，最后还是使用手写来梳理了一下。  

## 剥离功能
在这之前我是直接把demo的功能拷贝到项目下执行，主要是各种变量的问题（直接页面内加载资源的话也不会是多大问题）。功能还是能使用，但是总觉得里面有一些自己不使用的就想着把它去掉。  

- 页面分析
    - 好友列表
    - 最近联系人列表
    - 聊天页面

- 功能分析
    - 登录 （sdk/webim.min.js sdk/json2.js）
    - 好友
    - C2C聊天

页面使用 vue 的transition组件切换，默认传递参数 info ，已经消息状态（只是发送消息需要），以及列表页面跳转至聊天页面的一个数据回传  
```
<transition>
    <div :is="current" :info="info" :sendStatus="sendStatus" @input="updateInfo"></div>
</transition>
```

尽量把功能都在入口逻辑页面处理，组件内只是负责自己的逻辑，后续如果需要其它功能集成或者移除都很方便。  

### 登录
```
webim.login(
    loginInfo, listeners, options,
    function (resp) {
        loginInfo.identifierNick = resp.identifierNick;//设置当前用户昵称
        initDemoApp();
    },
    function (err) {
        alert(err.ErrorInfo);
    }
);
```
- loginInfo 主要是当前用户的一些用户信息
- listeners 监听了连接状态，监听了新消息（其它的按需监听）
- options 一个访问环境状态，一个是否输出日志状态
- 成功回调（初始化应用，这里需要注意this指向，webim是全局的，实际我的初始化函数并不是全局的）
- 失败回调（实际处理直接抛出错误，取消了弹出）

### 好友列表
帐号体系在自己这里，没有明确的好友关系，这个后续可以能会不需要暂时待定，但是肯定需要通过用户关系获取到用户的昵称或者头像等相关参数数据。  
```
webim.getAllFriend(options, function(resp) {
    // do
}, function(err) {
    // throw
})
```
实际可能会修改成这里是读取自己passpor数据，算了，这里没有，不瞎说了。用上面的方法去腾讯拉，我们是因为不需要这块，世界使用的时候报出的错误是连接服务器失败，这就尴尬了，应该是相关配置的原因。  

### 最近联系人列表
最近联系人列表这块是必须的，因为我们有一个手动关联的过程，用户需要到实体去使用过一次，后续才会通过在线咨询的方式与上次实体的相关人员联系起来。  
```
webim.getRecentContactList(options, function(resp) {
    // do
}, function(err) {
    // throw
});
```
但是这里最近联系人没有头像与昵称，这个就有一些尴尬了，只能给与设置一个默认的头像与昵称。 比较好的办法是这个过程中把所有的关联用户的sessionId同意存放起来，然后通过系统查询出来相关的信息作为map。后续才能直接使用。  
同时还有未读消息数也是需要通过我们的接口去拉取对应给我们的最近联系人，如果点开联系人跳转至聊天页面，这个为未读消息数量需要通过接口去清零。  

### 聊天界面
聊天界面暂时只是考虑文字与图片的发送，对于其它设备端的消息处理功能保留（语音消息只能听，网页端不能发送语音消息，即使有微信接口的借力也不行）。  
在 webim 登录时需要注册消息的监听，这个消息的监听是通过长轮询的方式来处理的，后续自己可以玩玩，这个过程中可以学习一下 websocket。  
```
webim.sendMsg(msg, function(resp) {
    // do
}, function(err) {
    // throw
});
```
看完demo中的代码，对于文字与图片这块的msg对象的处理方式不一样，其它都是一直的，如果发送成功回调一个消息状态，然后清空掉消息窗口的消息或者是图片窗口的弹窗隐藏。  
重点说一下图片的处理方式：  
demo中有直接处理图片对象的方法，也是作为base64的形式分段上传，这里使用直接文件对象的形式发送。  
```
//上传图片
webim.uploadPic(opt,
    function (resp) {
        // do
    },
    function (err) {
        // throw
    }
);
```
如果上传成功在成功回调函数中回调一个发送消息的方法，把图片发送给联系人。  
最后做统一的一个处理，如果消息发送成功给好友，这个需要把当前发送的消息追加到聊天窗口（这里是保留了demo中的处理方式，例如图片就是一个img标签，一个语音就是一个audio标签…）。  

## js本地预览图片技巧
这个之前有见到过还有另外一种方式，但是一时想不起来了，这里就使用一下当前demo中的方式，精简重现一下。  
<script async src="//jsfiddle.net/unofficial/o05t86m7/embed/result/"></script>

```
// html
<input id="file2base64" type="file">
<div id="imgs"></div>

// javascript
var fileEle = document.getElementById('file2base64'),
    imgsEle = document.getElementById('imgs');
fileEle.addEventListener('change', function(e) {
    var reader = new FileReader();
    reader.onload = function(e) {
        var img = new Image();
        img.src = e.target.result;
        imgsEle.appendChild(img); 
    }
    reader.readAsDataURL(e.target.files[0])
})
```

## IM

