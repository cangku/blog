---
title: 浏览器背后的故事
date: 2019-02-13 18:00:00
tags:
    - 非学前端

categories:
    - 学习
---

浏览器收到 `https://blog.unofficial.cn` 的响应正文以后是如何渲染出页面的？

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title></title>
</head>
    <body>
        <div id="app">
        </div>
        <script type="text/javascript" src="/assets/js/app.js"></script>
    </body>
</html>
```
## 浏览器
课程地址： https://classroom.udacity.com/courses/ud860/lessons/4138328558/concepts/41736185660923

## 60fps 与设备刷新频率
设备的刷新频率大多数都是 60次/秒 。其中每一帧的预算时间为 1s / 60 = 1.66ms 。浏览器实际工作过程中还要做一些整理工作，因此实际每帧的工作需要在 10ms 内完成。如果无法符合这个预算就可能出现卡顿现象。

**Pixel pipeline**

Javascript/CSS > Style > Layout > Paint > Composite
修改样式以后具体会引起重排或者重绘可以通过 [CSS触发器](https://csstriggers.com/) 查阅。

**Reflow 重排**

修改了元素的 layout 属性，改变了元素的几何属性 （宽 / 高 / 定位 etc.）
> Javascript/CSS > Style > Layout > Paint > Composite

**Repaint 重绘**

修改了元素的 paint 属性，改变了元素的非几何元素 （背景 / 字体颜色 / 阴影 etc.）
> Javascript/CSS > Style > Paint > Composite

**高性能动画**

> Javascript/CSS > Style > Composite

## Performance
* Frame Started Loading at 136 ms
* Send Request (blog.unofficial.cn)
* Receive Response
* Receive Data
* DOM Loading
* Finish Loading
* Parse HTML (DOM TREE)
    * Send Request (app.js)
    * Receive Response
    * Receive Data
    * DOM Loading
    * Finish Loading
    * Evaluate Script
        * Compile Script
            * Minor GC
* Recalculate Style (DOM + CSS) [得到 Render Tree ，和DOM Tree 比较起来少了 Head Script]
* Layout
* Update Layer Tree (frame)
* Paint (frame) [类似 Canvas 绘制元素的过程]
* Composite Layers (frame) [合成层]

// appendChild
* Parse HTML
* Update Layer Tree
* Composite Layers


Painting (Rasterize Paint)

* Image Decoded (内存中解码图片)

**Timing**  

* Queueing
    * 存在更高优先级的请求
    * 此源以及打开6哥TCP连接，达到限值。仅适用于 HTTP/1.0 和 HTTP/1.1
    * 浏览器正在短暂分配磁盘缓存中的空间
* Stalled 请求可能会因 Queueing 中描述的任何原因而停止
* DNS Lookup 浏览器正在解析请求中的 IP 地址
* Proxy negotiation 浏览器正在与代理服务器协商请求
* Request sent 正在发送请求
* ServiceWorker Preparation 浏览器正在启动 Service Worker
* Request to ServiceWorker 正在请求发送到 Service Worker
* Waiting（TTFB） 浏览器正在等待响应的第一个字节。TTFB：Time To First Byte
* Content Download 浏览器正在接收响应
* Receiving Push 浏览器正在通过 HTTP/2 服务器推送接收此响应的数据
* Reading Push 浏览器正在读取之前收到的本地数据

**RAIL**
Load 1s
Idle 50ms
Response 100ms
Animate 16ms (10-12ms)
![](http://udacity.github.io/60fps/images/time-table.jpg)


## 参考资料
https://developers.google.com/web/updates/2018/09/inside-browser-part1

https://toutiao.io/posts/uozd28/preview

https://developers.google.com/web/fundamentals/performance/rendering/

https://developers.google.com/web/tools/chrome-devtools/network-performance/reference#timing-explanation

[高性能](https://developers.google.com/web/fundamentals/performance/rendering/stick-to-compositor-only-properties-and-manage-layer-count)

https://cn.udacity.com/course/browser-rendering-optimization--ud860